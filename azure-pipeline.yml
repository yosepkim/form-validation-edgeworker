trigger:
- gitflow-update

pool:
  vmImage: ubuntu-latest

variables:
  - name: tag
    value: '$(Build.BuildNumber)'

stages:
- stage: test
  displayName: 'Build'
  jobs:
  - job: build_test
    displayName: 'Build and test'
    pool:
      vmImage: 'Ubuntu-latest'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: 'Install Node.js'
    - script: |
        npm install
        node --experimental-vm-modules node_modules/.bin/jest
      displayName: 'npm install, run Jest tests'

- stage: upload
  displayName: 'Uploading'
  dependsOn: test
  jobs:
  - deployment: upload
    displayName: 'Uploading'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Bash@3
            inputs:
              targetType: 'filpath'
              filepath: './azure-pipeline/upload.sh'
            env:
              EW_ID: '80521'
              ACCOUNT_KEY: '1-5BYUG1'

- stage: staging
  displayName: 'Staging'
  dependsOn: upload
  jobs:
  - deployment: activateStaging
    displayName: 'Activate staging'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Bash@3
            inputs:
              targetType: 'filpath'
              filepath: './azure-pipeline/activate.sh'
            env:
              TARGET_ENV: 'staging'
              EW_ID: '80521'
              ACCOUNT_KEY: '1-5BYUG1'

- stage: production
  displayName: 'Production'
  dependsOn: staging
  jobs:
  - deployment: activateProduction
    displayName: 'Activate production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Bash@3
            inputs:
              targetType: 'filpath'
              filepath: './azure-pipeline/deploy.sh'
            env:
              TARGET_ENV: 'production'
              EW_ID: '80521'
              ACCOUNT_KEY: '1-5BYUG1'